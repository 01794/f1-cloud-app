<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Replay de Sess√£o</title>
  <link rel="stylesheet" href="/static/css/telemetry.css" />
  <style>
    .controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 20px;
    }
    #progress-bar {
      flex: 1;
    }
    #tooltip {
      position: absolute;
      background: #222;
      color: #fff;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 14px;
      display: none;
      pointer-events: none;
      z-index: 10;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <h2>F1 REPLAY</h2>
      <a href="/">üèÅ Live</a>
      <a href="/analysis">üìä Analysis</a>
    </div>

    <div class="header">
      <label for="year">Ano:</label>
      <input type="number" id="year" value="2024" min="2021" max="2025" />
      <label for="round">Ronda:</label>
      <input type="number" id="round" value="1" min="1" max="25" />
      <label for="session">Sess√£o:</label>
      <input type="text" id="session" value="R" />
      <button onclick="startReplay()">Visualizar Sess√£o</button>
    </div>

    <!-- ‚úÖ Barra de controlo acima do mapa -->
    <div class="controls">
      <button onclick="togglePlayPause()">‚èØÔ∏è</button>
      <label for="speed-select" style="color:white;">Velocidade:</label>
      <select id="speed-select" onchange="updateSpeed()">
        <option value="1000">1x</option>
        <option value="500">2x</option>
        <option value="250">4x</option>
        <option value="100">10x</option>
      </select>
      <input type="range" id="progress-bar" min="0" value="0" step="1" oninput="seekFrame(this.value)" />
      <span id="time-label">0:00 / 0:00</span>
    </div>
    

    <div class="map" style="display: flex; gap: 20px; align-items: flex-start;">
      <div style="flex: 2;">
        <h3>Replay do Mapa</h3>
        <svg id="replay-map" viewBox="0 0 4000 4000" style="width: 100%; height: 500px; background-color: #111;"></svg>
      </div>
    
      <div style="flex: 1;">
        <h3 style="color: white;">Classifica√ß√£o Atual</h3>
        <table id="driver-table" style="width:100%; color: white; border-collapse: collapse;">
          <thead>
            <tr>
              <th style="border-bottom: 1px solid #888;">Pos</th>
              <th style="border-bottom: 1px solid #888;">N¬∫</th>
              <th style="border-bottom: 1px solid #888;">Nome</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    

    <div id="tooltip"></div>

    <script>
      let frames = [];
      let currentFrame = 0;
      let replayInterval;
      let pathCoords = [];
      let isPlaying = false;
      let playbackSpeed = 1000; // 1x = 1000ms


      function startReplay() {
        clearInterval(replayInterval);
        currentFrame = 0;
        isPlaying = false;

        const svg = document.getElementById('replay-map');
        svg.innerHTML = '';

        const year = document.getElementById('year').value;
        const round = document.getElementById('round').value;
        const session = document.getElementById('session').value;

        fetch(`/api/track_layout?year=${year}&round=${round}&session=${session}`)
          .then(res => res.json())
          .then(layout => {
            if (!Array.isArray(layout) || layout.length === 0) {
              alert("Erro ao carregar o tra√ßado da pista.");
              return;
            }

            pathCoords = layout;
            const path = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
            const points = layout.map(p => `${p.x},${p.y}`).join(" ");
            path.setAttribute("points", points);
            path.setAttribute("fill", "none");
            path.setAttribute("stroke", "#555");
            path.setAttribute("stroke-width", "5");
            svg.appendChild(path);

            fetch(`/api/replay_data?year=${year}&round=${round}&session=${session}`)
              .then(res => res.json())
              .then(data => {
                frames = data;
                updateViewBox();
                updateProgressUI();
                renderNextFrame();
              });
          });
      }

      function togglePlayPause() {
  isPlaying = !isPlaying;
  if (isPlaying) {
    replayInterval = setInterval(playNext, playbackSpeed);
  } else {
    clearInterval(replayInterval);
  }
}

function playNext() {
  if (currentFrame >= frames.length) {
    clearInterval(replayInterval);
    isPlaying = false;
    return;
  }
  renderNextFrame();
  currentFrame++;
  updateProgressUI();
}


      function seekFrame(value) {
        currentFrame = parseInt(value);
        renderNextFrame();
        updateProgressUI();
      }
      function updateSpeed() {
  playbackSpeed = parseInt(document.getElementById("speed-select").value);
  if (isPlaying) {
    clearInterval(replayInterval);
    replayInterval = setInterval(playNext, playbackSpeed);
  }
}


      function updateProgressUI() {
        const bar = document.getElementById("progress-bar");
        const label = document.getElementById("time-label");

        bar.max = frames.length - 1;
        bar.value = currentFrame;

        const format = sec => {
          const m = Math.floor(sec / 60);
          const s = Math.floor(sec % 60).toString().padStart(2, '0');
          return `${m}:${s}`;
        };

        label.textContent = `${format(currentFrame)} / ${format(frames.length)}`;
      }

      function updateViewBox() {
        let allX = pathCoords.map(p => p.x);
        let allY = pathCoords.map(p => p.y);
        frames.forEach(f => {
          f.positions.forEach(car => {
            allX.push(car.x);
            allY.push(car.y);
          });
        });

        const minX = Math.min(...allX);
        const maxX = Math.max(...allX);
        const minY = Math.min(...allY);
        const maxY = Math.max(...allY);
        const padding = 100;
        const width = (maxX - minX) + padding * 2;
        const height = (maxY - minY) + padding * 2;
        const viewBox = `${minX - padding} ${minY - padding} ${width} ${height}`;
        document.getElementById("replay-map").setAttribute("viewBox", viewBox);
      }

      function renderNextFrame() {
  const svg = document.getElementById('replay-map');
  const tooltipDiv = document.getElementById('tooltip');
  while (svg.children.length > 1) svg.removeChild(svg.lastChild);

  const positions = frames[currentFrame]?.positions || [];

  // Ordenar por dist√¢ncia para definir posi√ß√£o
  positions.sort((a, b) => b.distance - a.distance);
  positions.forEach((car, idx) => {
    car.position = idx + 1;
  });

  const tableBody = document.querySelector("#driver-table tbody");
  tableBody.innerHTML = "";

  positions.forEach(car => {
    const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    circle.setAttribute("cx", car.x);
    circle.setAttribute("cy", car.y);
    circle.setAttribute("r", 90);
    circle.setAttribute("fill", "blue");
    circle.setAttribute("stroke", "#fff");

    circle.addEventListener('mousemove', e => {
      tooltipDiv.style.left = (e.pageX + 10) + 'px';
      tooltipDiv.style.top = (e.pageY + 10) + 'px';
      tooltipDiv.textContent = `${car.position}¬∫ - ${car.driver_name}`;
      tooltipDiv.style.display = 'block';
    });

    circle.addEventListener('mouseout', () => {
      tooltipDiv.style.display = 'none';
    });

    const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
    label.setAttribute("x", car.x);
    label.setAttribute("y", car.y - 40);
    label.setAttribute("fill", "#fff");
    label.setAttribute("font-size", "22");
    label.setAttribute("text-anchor", "middle");
    label.textContent = car.driver_number;

    svg.appendChild(circle);
    svg.appendChild(label);

    const row = document.createElement("tr");
row.innerHTML = `
  <td>${car.position}¬∫</td>
  <td>${car.driver_number}</td>
  <td>${car.driver_name}</td>
`;
tableBody.appendChild(row);


  });
}

    </script>
</body>
</html>
